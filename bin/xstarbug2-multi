#!/usr/bin/python3 -Wignore
"""
usage: starbug2-multi [-BCDhv] [-n cores] [-p file.param] file.fits ...
"""
import os,sys, getopt
import multiprocessing
import subprocess
from starbug2.utils import printf, perror

VERBOSE=0x01
options=0

ncores=-1
files=[]
sbargs=""


def usage():
    if not(options&VERBOSE): quit(__doc__.split('\n')[1])
    else: quit(__doc__)

opts,args = getopt.getopt(sys.argv[1:], "BCDhvn:p:", ("help", "verbose", 
                                                "ncores=", "param="))
for opt,optarg in opts:
    if opt in ("-h","--help"): usage()
    if opt in ("-v","--verbose"): options|=VERBOSE

    if opt in ("-n","--ncores"): ncores=int(optarg)
    if opt in ("-p","--param"): sbargs+="-p%s "%optarg


    if opt=="-B": sbargs+="-B "
    if opt=="-C": sbargs+="-C "
    if opt=="-D": sbargs+="-D "

for fp in args:
    if os.path.exists(fp): files.append(fp)

def fn(fp):
    cmd="starbug2 -f %s %s"%(sbargs, fp)
    p=subprocess.run( (cmd.split()), stdout=subprocess.PIPE, stderr=subprocess.PIPE)
    printf("--> %s %d\n"%(cmd, p.returncode))

if ncores<0: ncores=len(files)

pool=multiprocessing.Pool(ncores)
pool.map(fn, files)

print("done")

